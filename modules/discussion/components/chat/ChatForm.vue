<template>
    <div class="order-chat-write">
        <div class="chat-write-img">
            <img src="~/assets/img/user-placeholder.png" alt="" />
        </div>
        <form class="chat-write-form" @submit.prevent="sendMessage">
            <div class="chat-write-input-wrap">
                <textarea
                    v-model="form.message"
                    class="chat-write-place"
                    :class="{ invalid: errors.message }"
                    placeholder="Введите Ваше сообщение"
                />
            </div>
            <div v-if="errors.message" class="chat-message-error-block">
                <div class="icon">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink"
                        width="17px"
                        height="17px"
                    >
                        <path
                            fill-rule="evenodd"
                            fill="rgb(190, 45, 52)"
                            d="M16.102,5.558 C16.143,5.665 16.184,5.772 16.221,5.882 C16.278,6.060 16.336,6.235 16.382,6.416 C16.482,6.795 16.552,7.183 16.599,7.576 C16.601,7.592 16.602,7.607 16.604,7.623 C16.714,8.600 16.664,9.610 16.411,10.617 C15.613,13.616 13.260,15.831 10.391,16.559 C10.081,16.640 9.771,16.709 9.458,16.753 C9.336,16.769 9.213,16.774 9.091,16.785 C8.731,16.819 8.373,16.830 8.015,16.818 C7.970,16.816 7.926,16.824 7.881,16.822 C7.865,16.821 7.852,16.811 7.836,16.809 C5.821,16.694 3.877,15.865 2.402,14.385 C2.211,14.186 2.068,13.961 1.900,13.749 C1.875,13.718 1.850,13.687 1.826,13.655 C1.472,13.197 1.171,12.717 0.925,12.211 C0.852,12.065 0.768,11.924 0.703,11.775 C0.633,11.607 0.581,11.436 0.522,11.265 C0.399,10.920 0.300,10.569 0.223,10.211 C0.208,10.136 0.188,10.063 0.175,9.988 C-0.052,8.773 -0.030,7.507 0.298,6.271 C1.030,3.676 2.903,1.720 5.216,0.784 C5.218,0.783 5.221,0.782 5.223,0.781 C5.684,0.595 6.162,0.449 6.653,0.348 C6.730,0.332 6.807,0.319 6.884,0.305 C7.292,0.233 7.705,0.187 8.124,0.178 C8.297,0.172 8.468,0.179 8.640,0.184 C8.890,0.194 9.140,0.217 9.391,0.250 C9.754,0.294 10.111,0.364 10.468,0.456 C10.472,0.458 10.476,0.458 10.480,0.459 C10.487,0.461 10.494,0.464 10.502,0.466 C11.849,0.821 13.133,1.483 14.202,2.526 C15.077,3.406 15.694,4.449 16.102,5.558 ZM13.823,12.737 C13.883,12.659 13.928,12.571 13.985,12.490 C14.172,12.220 14.349,11.943 14.496,11.652 C14.547,11.550 14.588,11.442 14.635,11.337 C14.764,11.046 14.878,10.750 14.967,10.445 C14.996,10.342 15.021,10.239 15.047,10.135 C15.122,9.819 15.175,9.499 15.207,9.175 C15.217,9.068 15.228,8.961 15.234,8.852 C15.249,8.563 15.233,8.272 15.211,7.981 C15.198,7.801 15.184,7.622 15.158,7.447 C15.113,7.157 15.045,6.869 14.963,6.584 C14.921,6.437 14.880,6.291 14.829,6.149 C14.720,5.847 14.584,5.550 14.430,5.258 C14.368,5.140 14.309,5.021 14.241,4.907 C14.071,4.625 13.877,4.366 13.675,4.117 C13.585,4.007 13.501,3.893 13.405,3.788 C13.202,3.567 12.979,3.372 12.753,3.182 C12.634,3.082 12.521,2.977 12.396,2.885 C12.162,2.715 11.914,2.573 11.664,2.434 C11.525,2.358 11.392,2.274 11.248,2.207 C10.998,2.091 10.737,2.003 10.475,1.917 C10.308,1.862 10.144,1.802 9.972,1.760 C9.733,1.701 9.489,1.670 9.246,1.637 C9.029,1.609 8.814,1.579 8.591,1.571 C8.370,1.563 8.148,1.576 7.926,1.589 C7.687,1.603 7.448,1.622 7.216,1.661 C6.995,1.697 6.776,1.752 6.557,1.811 C6.338,1.870 6.122,1.932 5.913,2.012 C5.692,2.095 5.476,2.199 5.260,2.307 C5.062,2.407 4.864,2.507 4.677,2.626 C4.488,2.745 4.315,2.879 4.141,3.013 C3.947,3.164 3.752,3.313 3.575,3.483 C3.446,3.607 3.333,3.743 3.215,3.875 C3.032,4.080 2.851,4.286 2.693,4.511 C2.601,4.643 2.525,4.784 2.443,4.921 C2.296,5.166 2.153,5.413 2.036,5.676 C1.972,5.819 1.926,5.969 1.872,6.116 C1.771,6.393 1.676,6.673 1.610,6.965 C1.578,7.105 1.562,7.248 1.539,7.389 C1.488,7.705 1.450,8.025 1.443,8.354 C1.440,8.488 1.448,8.622 1.453,8.756 C1.465,9.086 1.494,9.410 1.550,9.726 C1.577,9.875 1.614,10.023 1.650,10.171 C1.722,10.460 1.806,10.742 1.911,11.015 C1.975,11.181 2.053,11.343 2.131,11.506 C2.252,11.759 2.379,12.009 2.529,12.243 C2.612,12.373 2.703,12.494 2.793,12.616 C2.960,12.844 3.137,13.065 3.330,13.270 C3.443,13.390 3.562,13.501 3.682,13.611 C4.841,14.681 6.356,15.351 8.034,15.428 C8.168,15.434 8.300,15.452 8.435,15.451 C9.273,15.439 10.074,15.278 10.815,14.992 C11.147,14.864 11.476,14.715 11.795,14.530 C12.608,14.058 13.286,13.443 13.823,12.737 ZM8.302,13.271 C7.973,13.271 7.675,13.072 7.549,12.765 C7.423,12.459 7.493,12.107 7.726,11.873 C7.959,11.638 8.310,11.568 8.614,11.695 C8.919,11.822 9.117,12.121 9.117,12.452 C9.117,12.904 8.752,13.271 8.302,13.271 ZM8.302,10.486 C7.852,10.486 7.487,10.120 7.487,9.667 L7.487,4.459 C7.487,4.007 7.852,3.640 8.302,3.640 C8.752,3.640 9.117,4.007 9.117,4.459 L9.117,9.667 C9.117,10.120 8.752,10.486 8.302,10.486 Z"
                        />
                    </svg>
                </div>
                <div class="text">
                    <p>{{ errors.message[0] }}</p>
                </div>
            </div>
            <chat-uploader v-model="form.files" />
            <div class="chat-write-send">
                <button class="btn">Написать</button>
            </div>
        </form>
    </div>
</template>

<script>
import ChatUploader from './ChatUploader.vue';

export default {
    components: { ChatUploader },
    data() {
        return {
            form: {
                message: '',
                files: [],
            },
            errors: {},
        };
    },
    methods: {
        sendMessage() {
            this.errors = {};
            const fd = new FormData();
            this.form.files.forEach((file, index) => {
                fd.append(`files[${index}]`, file, file.name);
            });
            fd.append('message', this.form.message);
            this.$axios
                .post('/deals/chat/store', fd, {
                    headers: { 'Content-Type': 'multipart/form-data' },
                })
                .then(() => {
                    this.form = {
                        message: '',
                        files: [],
                    };
                    this.$emit('sendingMessage');
                    this.$nuxt.$emit('chat-uploader-reset-errors');
                })
                .catch((err) => {
                    this.errors = err.response.data.errors;
                });
        },
    },
};
</script>

<style lang="scss" scoped></style>
